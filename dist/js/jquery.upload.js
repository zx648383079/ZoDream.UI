var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Eve = /** @class */ (function () {
    function Eve() {
    }
    Eve.prototype.on = function (event, callback) {
        this.options['on' + event] = callback;
        return this;
    };
    Eve.prototype.hasEvent = function (event) {
        return this.options.hasOwnProperty('on' + event);
    };
    Eve.prototype.trigger = function (event) {
        var args = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            args[_i - 1] = arguments[_i];
        }
        var realEvent = 'on' + event;
        if (!this.hasEvent(event)) {
            return;
        }
        return (_a = this.options[realEvent]).call.apply(_a, [this].concat(args));
        var _a;
    };
    return Eve;
}());
/*!
 * jquery.upload - https://github.com/zx648383079/ZoDream.UI
 * Version - 1.0
 * Licensed under the MIT license - http://opensource.org/licenses/MIT
 *
 * Copyright (c) 2017 ZoDream
 */
/**
 * EXAMPLE:
 * $('#upload').upload({
 *      url: 'upload.php',
 *      name: 'file',
 *      template: '{url}',
 *      grid: '.img'
 * });
 */
var Upload = /** @class */ (function (_super) {
    __extends(Upload, _super);
    function Upload(element, option) {
        var _this = _super.call(this) || this;
        _this.element = element;
        _this.options = $.extend({}, new UploadDefaultOption(), option);
        _this.options.data = $.extend({}, _this.options.data, _this.getData());
        _this.getElement = _this.options.getElement.bind(_this);
        if (_this.element) {
            _this.addEvent();
        }
        return _this;
    }
    Upload.prototype.addEvent = function () {
        var instance = this;
        this.element.click(function () {
            instance.start($(this));
        });
        if (this.options.grid) {
            $(this.options.grid).on('click', this.options.removeTag, this.options.removeCallback);
        }
    };
    Upload.prototype.start = function (currentElement) {
        this.currentElement = currentElement;
        var instance = this;
        var element = $('.' + this.options.fileClass);
        if (element.length < 1) {
            var file = document.createElement('input');
            file.type = 'file';
            file.className = this.options.fileClass;
            file.multiple = this.options.multiple;
            file.accept = this.options.filter;
            document.body.appendChild(file);
            element = $(file).bind('change', function () {
                instance.uploadFiles(this.files);
            }).hide();
        }
        else {
            element.val('');
            element.attr('multiple', this.options.multiple ? 'true' : 'false');
            element.attr('accept', this.options.filter);
            if (this.options.dynamic) {
                element.unbind('change').bind('change', function () {
                    instance.uploadFiles(this.files);
                });
            }
        }
        element.click();
    };
    Upload.prototype.uploadFiles = function (files) {
        if (this.options.allowMultiple) {
            this.uploadMany(files);
            return;
        }
        var instance = this;
        $.each(files, function (i, file) {
            instance.uploadOne(file);
        });
    };
    Upload.prototype.uploadMany = function (files) {
        var instance = this;
        var data = new FormData();
        $.each(files, function (i, file) {
            data.append(instance.options.name, file);
        });
        if (this.trigger('before', data, this.currentElement) === false) {
            console.log('before upload is false');
            return;
        }
        var opts = {
            url: this.options.url,
            type: 'POST',
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            success: function (data) {
                data = instance.trigger('after', data, instance.currentElement);
                if (data == false) {
                    console.log('after upload is false');
                    return;
                }
                if (data instanceof Array) {
                    $.each(data, function (i, item) {
                        instance.deal($.extend({}, instance.options.data, item));
                    });
                    return;
                }
                instance.deal($.extend({}, instance.options.data, data));
            }
        };
        if (this.hasEvent('progress')) {
            opts['xhr'] = function () {
                var xhr = $.ajaxSettings.xhr();
                if (onprogress && xhr.upload) {
                    xhr.upload.addEventListener('progress', this.options.onprogress, false);
                    return xhr;
                }
            };
        }
        $.ajax(opts);
    };
    Upload.prototype.uploadOne = function (file) {
        var instance = this;
        var data = new FormData();
        data.append(this.options.name, file);
        if (this.trigger('before', data, this.currentElement) === false) {
            console.log('before upload is false');
            return;
        }
        var opts = {
            url: this.options.url,
            type: 'POST',
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            success: function (data) {
                data = instance.trigger('after', data, instance.currentElement);
                if (data == false) {
                    console.log('after upload is false');
                    return;
                }
                instance.deal($.extend({}, instance.options.data, data));
            }
        };
        if (this.hasEvent('progress')) {
            opts['xhr'] = function () {
                var xhr = $.ajaxSettings.xhr();
                if (onprogress && xhr.upload) {
                    xhr.upload.addEventListener('progress', this.options.onprogress, false);
                    return xhr;
                }
            };
        }
        $.ajax(opts);
    };
    Upload.prototype.deal = function (data) {
        var value = typeof this.options.template == 'function' ? this.options.template.call(this, data) : this.replace(data);
        if (value == false) {
            console.log('template is false');
            return;
        }
        if (false === this.trigger('success', data, this.currentElement)) {
            console.log('success is false');
            return;
        }
        var urlFor = this.options.grid;
        if (this.currentElement && this.currentElement.length > 0) {
            urlFor = this.currentElement.attr('data-grid') || this.options.grid;
        }
        if (!urlFor) {
            console.log('grid element is false');
            return;
        }
        var tags = urlFor.split('|');
        var instance = this;
        tags.forEach(function (tag) {
            var item = instance.getElement(tag, instance.currentElement);
            if (item.length == 0) {
                return;
            }
            item.each(function (i, element) {
                var ele = $(element);
                if (ele.is('input') || ele.is('textarea')) {
                    ele.val(value);
                    return;
                }
                if (ele.is('img')) {
                    ele.attr('src', value);
                    return;
                }
                if (instance.options.isAppend) {
                    ele.append(value);
                }
                else {
                    ele.prepend(value);
                }
            });
        });
    };
    Upload.prototype.getData = function () {
        if (!this.element || this.element.length < 1) {
            return {};
        }
        var data = {};
        var arg = this.element.attr('data-data');
        if (!arg) {
            return data;
        }
        var args = arg.split(',');
        args.forEach(function (item) {
            var keyValue = item.split(':');
            var key = keyValue[0].trim();
            if (key) {
                data[key] = keyValue[1].trim();
            }
        });
        return data;
    };
    Upload.prototype.replace = function (data) {
        var html = typeof this.options.template == 'function' ? this.options.template.call(this, data) : this.options.template;
        for (var i in data) {
            if (data.hasOwnProperty(i)) {
                html = html.replace(new RegExp('{' + i + '}', 'g'), data[i]);
            }
        }
        return html;
    };
    return Upload;
}(Eve));
var UploadDefaultOption = /** @class */ (function () {
    function UploadDefaultOption() {
        this.name = 'file';
        this.isAppend = true;
        this.template = '{url}';
        //grid: string = '.zdGrid';
        this.removeTag = '.delete';
        this.removeCallback = function () {
            $(this).parent().remove();
        };
        this.multiple = false;
        this.allowMultiple = false;
        this.data = {};
        this.fileClass = 'zdUploadFile';
        this.filter = '';
        this.onafter = function (data) {
            // 防止ajax自动转化json
            if (typeof data != 'object') {
                data = JSON.parse(data);
            }
            if (data.code == 0) {
                return data.data;
            }
            return false;
        };
        this.dynamic = true;
        this.getElement = function (tag) {
            return $(tag);
        };
    }
    return UploadDefaultOption;
}());
;
(function ($) {
    $.fn.upload = function (option) {
        return new Upload(this, option);
    };
})(jQuery);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV2ZW50LnRzIiwianF1ZXJ5LnVwbG9hZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7SUFBQTtJQW1CQSxDQUFBO0lBaEJBLGdCQUFBLEdBQUEsVUFBQSxLQUFBLEVBQUEsUUFBQTtRQUNBLElBQUEsQ0FBQSxPQUFBLENBQUEsSUFBQSxHQUFBLEtBQUEsQ0FBQSxHQUFBLFFBQUEsQ0FBQTtRQUNBLE1BQUEsQ0FBQSxJQUFBLENBQUE7SUFDQSxDQUFBO0lBRUEsc0JBQUEsR0FBQSxVQUFBLEtBQUE7UUFDQSxNQUFBLENBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxjQUFBLENBQUEsSUFBQSxHQUFBLEtBQUEsQ0FBQSxDQUFBO0lBQ0EsQ0FBQTtJQUVBLHFCQUFBLEdBQUEsVUFBQSxLQUFBO1FBQUEsY0FBQTthQUFBLFVBQUEsRUFBQSxxQkFBQSxFQUFBLElBQUE7WUFBQSw2QkFBQTs7UUFDQSxJQUFBLFNBQUEsR0FBQSxJQUFBLEdBQUEsS0FBQSxDQUFBO1FBQ0EsRUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsUUFBQSxDQUFBLEtBQUEsQ0FBQSxDQUFBLENBQUEsQ0FBQTtZQUNBLE1BQUEsQ0FBQTtRQUNBLENBQUE7UUFDQSxNQUFBLENBQUEsQ0FBQSxLQUFBLElBQUEsQ0FBQSxPQUFBLENBQUEsU0FBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLFlBQUEsSUFBQSxTQUFBLElBQUEsR0FBQTs7SUFDQSxDQUFBO0lBQ0EsVUFBQTtBQUFBLENBbkJBLEFBbUJBLElBQUE7QUNuQkE7Ozs7OztHQU1BO0FBQ0E7Ozs7Ozs7O0dBUUE7QUFDQTtJQUFBLDBCQUFBO0lBQ0EsZ0JBQ0EsT0FBQSxFQUNBLE1BQUE7UUFGQSxZQUlBLGlCQUFBLFNBT0E7UUFWQSxhQUFBLEdBQUEsT0FBQSxDQUFBO1FBSUEsS0FBQSxDQUFBLE9BQUEsR0FBQSxDQUFBLENBQUEsTUFBQSxDQUFBLEVBQUEsRUFBQSxJQUFBLG1CQUFBLEVBQUEsRUFBQSxNQUFBLENBQUEsQ0FBQTtRQUNBLEtBQUEsQ0FBQSxPQUFBLENBQUEsSUFBQSxHQUFBLENBQUEsQ0FBQSxNQUFBLENBQUEsRUFBQSxFQUFBLEtBQUEsQ0FBQSxPQUFBLENBQUEsSUFBQSxFQUFBLEtBQUEsQ0FBQSxPQUFBLEVBQUEsQ0FBQSxDQUFBO1FBQ0EsS0FBQSxDQUFBLFVBQUEsR0FBQSxLQUFBLENBQUEsT0FBQSxDQUFBLFVBQUEsQ0FBQSxJQUFBLENBQUEsS0FBQSxDQUFBLENBQUE7UUFDQSxFQUFBLENBQUEsQ0FBQSxLQUFBLENBQUEsT0FBQSxDQUFBLENBQUEsQ0FBQTtZQUNBLEtBQUEsQ0FBQSxRQUFBLEVBQUEsQ0FBQTtRQUNBLENBQUE7O0lBQ0EsQ0FBQTtJQVVBLHlCQUFBLEdBQUE7UUFDQSxJQUFBLFFBQUEsR0FBQSxJQUFBLENBQUE7UUFDQSxJQUFBLENBQUEsT0FBQSxDQUFBLEtBQUEsQ0FBQTtZQUNBLFFBQUEsQ0FBQSxLQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBLENBQUE7UUFDQSxDQUFBLENBQUEsQ0FBQTtRQUNBLEVBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBQSxPQUFBLENBQUEsSUFBQSxDQUFBLENBQUEsQ0FBQTtZQUNBLENBQUEsQ0FBQSxJQUFBLENBQUEsT0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBLEVBQUEsQ0FBQSxPQUFBLEVBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxTQUFBLEVBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxjQUFBLENBQUEsQ0FBQTtRQUNBLENBQUE7SUFDQSxDQUFBO0lBRUEsc0JBQUEsR0FBQSxVQUFBLGNBQUE7UUFDQSxJQUFBLENBQUEsY0FBQSxHQUFBLGNBQUEsQ0FBQTtRQUNBLElBQUEsUUFBQSxHQUFBLElBQUEsQ0FBQTtRQUNBLElBQUEsT0FBQSxHQUFBLENBQUEsQ0FBQSxHQUFBLEdBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxTQUFBLENBQUEsQ0FBQTtRQUNBLEVBQUEsQ0FBQSxDQUFBLE9BQUEsQ0FBQSxNQUFBLEdBQUEsQ0FBQSxDQUFBLENBQUEsQ0FBQTtZQUNBLElBQUEsSUFBQSxHQUFBLFFBQUEsQ0FBQSxhQUFBLENBQUEsT0FBQSxDQUFBLENBQUE7WUFDQSxJQUFBLENBQUEsSUFBQSxHQUFBLE1BQUEsQ0FBQTtZQUNBLElBQUEsQ0FBQSxTQUFBLEdBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxTQUFBLENBQUE7WUFDQSxJQUFBLENBQUEsUUFBQSxHQUFBLElBQUEsQ0FBQSxPQUFBLENBQUEsUUFBQSxDQUFBO1lBQ0EsSUFBQSxDQUFBLE1BQUEsR0FBQSxJQUFBLENBQUEsT0FBQSxDQUFBLE1BQUEsQ0FBQTtZQUNBLFFBQUEsQ0FBQSxJQUFBLENBQUEsV0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO1lBQ0EsT0FBQSxHQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsUUFBQSxFQUFBO2dCQUNBLFFBQUEsQ0FBQSxXQUFBLENBQUEsSUFBQSxDQUFBLEtBQUEsQ0FBQSxDQUFBO1lBQ0EsQ0FBQSxDQUFBLENBQUEsSUFBQSxFQUFBLENBQUE7UUFDQSxDQUFBO1FBQUEsSUFBQSxDQUFBLENBQUE7WUFDQSxPQUFBLENBQUEsR0FBQSxDQUFBLEVBQUEsQ0FBQSxDQUFBO1lBQ0EsT0FBQSxDQUFBLElBQUEsQ0FBQSxVQUFBLEVBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxRQUFBLENBQUEsQ0FBQSxDQUFBLE1BQUEsQ0FBQSxDQUFBLENBQUEsT0FBQSxDQUFBLENBQUE7WUFDQSxPQUFBLENBQUEsSUFBQSxDQUFBLFFBQUEsRUFBQSxJQUFBLENBQUEsT0FBQSxDQUFBLE1BQUEsQ0FBQSxDQUFBO1lBQ0EsRUFBQSxDQUFBLENBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxPQUFBLENBQUEsQ0FBQSxDQUFBO2dCQUNBLE9BQUEsQ0FBQSxNQUFBLENBQUEsUUFBQSxDQUFBLENBQUEsSUFBQSxDQUFBLFFBQUEsRUFBQTtvQkFDQSxRQUFBLENBQUEsV0FBQSxDQUFBLElBQUEsQ0FBQSxLQUFBLENBQUEsQ0FBQTtnQkFDQSxDQUFBLENBQUEsQ0FBQTtZQUNBLENBQUE7UUFDQSxDQUFBO1FBQ0EsT0FBQSxDQUFBLEtBQUEsRUFBQSxDQUFBO0lBQ0EsQ0FBQTtJQUVBLDRCQUFBLEdBQUEsVUFBQSxLQUFBO1FBQ0EsRUFBQSxDQUFBLENBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxhQUFBLENBQUEsQ0FBQSxDQUFBO1lBQ0EsSUFBQSxDQUFBLFVBQUEsQ0FBQSxLQUFBLENBQUEsQ0FBQTtZQUNBLE1BQUEsQ0FBQTtRQUNBLENBQUE7UUFDQSxJQUFBLFFBQUEsR0FBQSxJQUFBLENBQUE7UUFDQSxDQUFBLENBQUEsSUFBQSxDQUFBLEtBQUEsRUFBQSxVQUFBLENBQUEsRUFBQSxJQUFBO1lBQ0EsUUFBQSxDQUFBLFNBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtRQUNBLENBQUEsQ0FBQSxDQUFBO0lBQ0EsQ0FBQTtJQUVBLDJCQUFBLEdBQUEsVUFBQSxLQUFBO1FBQ0EsSUFBQSxRQUFBLEdBQUEsSUFBQSxDQUFBO1FBQ0EsSUFBQSxJQUFBLEdBQUEsSUFBQSxRQUFBLEVBQUEsQ0FBQTtRQUNBLENBQUEsQ0FBQSxJQUFBLENBQUEsS0FBQSxFQUFBLFVBQUEsQ0FBQSxFQUFBLElBQUE7WUFDQSxJQUFBLENBQUEsTUFBQSxDQUFBLFFBQUEsQ0FBQSxPQUFBLENBQUEsSUFBQSxFQUFBLElBQUEsQ0FBQSxDQUFBO1FBQ0EsQ0FBQSxDQUFBLENBQUE7UUFDQSxFQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsT0FBQSxDQUFBLFFBQUEsRUFBQSxJQUFBLEVBQUEsSUFBQSxDQUFBLGNBQUEsQ0FBQSxLQUFBLEtBQUEsQ0FBQSxDQUFBLENBQUE7WUFDQSxPQUFBLENBQUEsR0FBQSxDQUFBLHdCQUFBLENBQUEsQ0FBQTtZQUNBLE1BQUEsQ0FBQTtRQUNBLENBQUE7UUFDQSxJQUFBLElBQUEsR0FBQTtZQUNBLEdBQUEsRUFBQSxJQUFBLENBQUEsT0FBQSxDQUFBLEdBQUE7WUFDQSxJQUFBLEVBQUEsTUFBQTtZQUNBLElBQUEsRUFBQSxJQUFBO1lBQ0EsS0FBQSxFQUFBLEtBQUE7WUFDQSxXQUFBLEVBQUEsS0FBQTtZQUNBLFdBQUEsRUFBQSxLQUFBO1lBQ0EsT0FBQSxFQUFBLFVBQUEsSUFBQTtnQkFDQSxJQUFBLEdBQUEsUUFBQSxDQUFBLE9BQUEsQ0FBQSxPQUFBLEVBQUEsSUFBQSxFQUFBLFFBQUEsQ0FBQSxjQUFBLENBQUEsQ0FBQTtnQkFDQSxFQUFBLENBQUEsQ0FBQSxJQUFBLElBQUEsS0FBQSxDQUFBLENBQUEsQ0FBQTtvQkFDQSxPQUFBLENBQUEsR0FBQSxDQUFBLHVCQUFBLENBQUEsQ0FBQTtvQkFDQSxNQUFBLENBQUE7Z0JBQ0EsQ0FBQTtnQkFDQSxFQUFBLENBQUEsQ0FBQSxJQUFBLFlBQUEsS0FBQSxDQUFBLENBQUEsQ0FBQTtvQkFDQSxDQUFBLENBQUEsSUFBQSxDQUFBLElBQUEsRUFBQSxVQUFBLENBQUEsRUFBQSxJQUFBO3dCQUNBLFFBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQSxDQUFBLE1BQUEsQ0FBQSxFQUFBLEVBQUEsUUFBQSxDQUFBLE9BQUEsQ0FBQSxJQUFBLEVBQUEsSUFBQSxDQUFBLENBQUEsQ0FBQTtvQkFDQSxDQUFBLENBQUEsQ0FBQTtvQkFDQSxNQUFBLENBQUE7Z0JBQ0EsQ0FBQTtnQkFDQSxRQUFBLENBQUEsSUFBQSxDQUFBLENBQUEsQ0FBQSxNQUFBLENBQUEsRUFBQSxFQUFBLFFBQUEsQ0FBQSxPQUFBLENBQUEsSUFBQSxFQUFBLElBQUEsQ0FBQSxDQUFBLENBQUE7WUFDQSxDQUFBO1NBQ0EsQ0FBQTtRQUNBLEVBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBQSxRQUFBLENBQUEsVUFBQSxDQUFBLENBQUEsQ0FBQSxDQUFBO1lBQ0EsSUFBQSxDQUFBLEtBQUEsQ0FBQSxHQUFBO2dCQUNBLElBQUEsR0FBQSxHQUFBLENBQUEsQ0FBQSxZQUFBLENBQUEsR0FBQSxFQUFBLENBQUE7Z0JBQ0EsRUFBQSxDQUFBLENBQUEsVUFBQSxJQUFBLEdBQUEsQ0FBQSxNQUFBLENBQUEsQ0FBQSxDQUFBO29CQUNBLEdBQUEsQ0FBQSxNQUFBLENBQUEsZ0JBQUEsQ0FBQSxVQUFBLEVBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxVQUFBLEVBQUEsS0FBQSxDQUFBLENBQUE7b0JBQ0EsTUFBQSxDQUFBLEdBQUEsQ0FBQTtnQkFDQSxDQUFBO1lBQ0EsQ0FBQSxDQUFBO1FBQ0EsQ0FBQTtRQUNBLENBQUEsQ0FBQSxJQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7SUFDQSxDQUFBO0lBRUEsMEJBQUEsR0FBQSxVQUFBLElBQUE7UUFDQSxJQUFBLFFBQUEsR0FBQSxJQUFBLENBQUE7UUFDQSxJQUFBLElBQUEsR0FBQSxJQUFBLFFBQUEsRUFBQSxDQUFBO1FBQ0EsSUFBQSxDQUFBLE1BQUEsQ0FBQSxJQUFBLENBQUEsT0FBQSxDQUFBLElBQUEsRUFBQSxJQUFBLENBQUEsQ0FBQTtRQUNBLEVBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBQSxPQUFBLENBQUEsUUFBQSxFQUFBLElBQUEsRUFBQSxJQUFBLENBQUEsY0FBQSxDQUFBLEtBQUEsS0FBQSxDQUFBLENBQUEsQ0FBQTtZQUNBLE9BQUEsQ0FBQSxHQUFBLENBQUEsd0JBQUEsQ0FBQSxDQUFBO1lBQ0EsTUFBQSxDQUFBO1FBQ0EsQ0FBQTtRQUNBLElBQUEsSUFBQSxHQUFBO1lBQ0EsR0FBQSxFQUFBLElBQUEsQ0FBQSxPQUFBLENBQUEsR0FBQTtZQUNBLElBQUEsRUFBQSxNQUFBO1lBQ0EsSUFBQSxFQUFBLElBQUE7WUFDQSxLQUFBLEVBQUEsS0FBQTtZQUNBLFdBQUEsRUFBQSxLQUFBO1lBQ0EsV0FBQSxFQUFBLEtBQUE7WUFDQSxPQUFBLEVBQUEsVUFBQSxJQUFBO2dCQUNBLElBQUEsR0FBQSxRQUFBLENBQUEsT0FBQSxDQUFBLE9BQUEsRUFBQSxJQUFBLEVBQUEsUUFBQSxDQUFBLGNBQUEsQ0FBQSxDQUFBO2dCQUNBLEVBQUEsQ0FBQSxDQUFBLElBQUEsSUFBQSxLQUFBLENBQUEsQ0FBQSxDQUFBO29CQUNBLE9BQUEsQ0FBQSxHQUFBLENBQUEsdUJBQUEsQ0FBQSxDQUFBO29CQUNBLE1BQUEsQ0FBQTtnQkFDQSxDQUFBO2dCQUNBLFFBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQSxDQUFBLE1BQUEsQ0FBQSxFQUFBLEVBQUEsUUFBQSxDQUFBLE9BQUEsQ0FBQSxJQUFBLEVBQUEsSUFBQSxDQUFBLENBQUEsQ0FBQTtZQUNBLENBQUE7U0FDQSxDQUFBO1FBQ0EsRUFBQSxDQUFBLENBQUEsSUFBQSxDQUFBLFFBQUEsQ0FBQSxVQUFBLENBQUEsQ0FBQSxDQUFBLENBQUE7WUFDQSxJQUFBLENBQUEsS0FBQSxDQUFBLEdBQUE7Z0JBQ0EsSUFBQSxHQUFBLEdBQUEsQ0FBQSxDQUFBLFlBQUEsQ0FBQSxHQUFBLEVBQUEsQ0FBQTtnQkFDQSxFQUFBLENBQUEsQ0FBQSxVQUFBLElBQUEsR0FBQSxDQUFBLE1BQUEsQ0FBQSxDQUFBLENBQUE7b0JBQ0EsR0FBQSxDQUFBLE1BQUEsQ0FBQSxnQkFBQSxDQUFBLFVBQUEsRUFBQSxJQUFBLENBQUEsT0FBQSxDQUFBLFVBQUEsRUFBQSxLQUFBLENBQUEsQ0FBQTtvQkFDQSxNQUFBLENBQUEsR0FBQSxDQUFBO2dCQUNBLENBQUE7WUFDQSxDQUFBLENBQUE7UUFDQSxDQUFBO1FBQ0EsQ0FBQSxDQUFBLElBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtJQUNBLENBQUE7SUFFQSxxQkFBQSxHQUFBLFVBQUEsSUFBQTtRQUNBLElBQUEsS0FBQSxHQUFBLE9BQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxRQUFBLElBQUEsVUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsT0FBQSxDQUFBLFFBQUEsQ0FBQSxJQUFBLENBQUEsSUFBQSxFQUFBLElBQUEsQ0FBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsT0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO1FBQ0EsRUFBQSxDQUFBLENBQUEsS0FBQSxJQUFBLEtBQUEsQ0FBQSxDQUFBLENBQUE7WUFDQSxPQUFBLENBQUEsR0FBQSxDQUFBLG1CQUFBLENBQUEsQ0FBQTtZQUNBLE1BQUEsQ0FBQTtRQUNBLENBQUE7UUFDQSxFQUFBLENBQUEsQ0FBQSxLQUFBLEtBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxTQUFBLEVBQUEsSUFBQSxFQUFBLElBQUEsQ0FBQSxjQUFBLENBQUEsQ0FBQSxDQUFBLENBQUE7WUFDQSxPQUFBLENBQUEsR0FBQSxDQUFBLGtCQUFBLENBQUEsQ0FBQTtZQUNBLE1BQUEsQ0FBQTtRQUNBLENBQUE7UUFDQSxJQUFBLE1BQUEsR0FBQSxJQUFBLENBQUEsT0FBQSxDQUFBLElBQUEsQ0FBQTtRQUNBLEVBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBQSxjQUFBLElBQUEsSUFBQSxDQUFBLGNBQUEsQ0FBQSxNQUFBLEdBQUEsQ0FBQSxDQUFBLENBQUEsQ0FBQTtZQUNBLE1BQUEsR0FBQSxJQUFBLENBQUEsY0FBQSxDQUFBLElBQUEsQ0FBQSxXQUFBLENBQUEsSUFBQSxJQUFBLENBQUEsT0FBQSxDQUFBLElBQUEsQ0FBQTtRQUNBLENBQUE7UUFDQSxFQUFBLENBQUEsQ0FBQSxDQUFBLE1BQUEsQ0FBQSxDQUFBLENBQUE7WUFDQSxPQUFBLENBQUEsR0FBQSxDQUFBLHVCQUFBLENBQUEsQ0FBQTtZQUNBLE1BQUEsQ0FBQTtRQUNBLENBQUE7UUFDQSxJQUFBLElBQUEsR0FBQSxNQUFBLENBQUEsS0FBQSxDQUFBLEdBQUEsQ0FBQSxDQUFBO1FBQ0EsSUFBQSxRQUFBLEdBQUEsSUFBQSxDQUFBO1FBQ0EsSUFBQSxDQUFBLE9BQUEsQ0FBQSxVQUFBLEdBQUE7WUFDQSxJQUFBLElBQUEsR0FBQSxRQUFBLENBQUEsVUFBQSxDQUFBLEdBQUEsRUFBQSxRQUFBLENBQUEsY0FBQSxDQUFBLENBQUE7WUFDQSxFQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsTUFBQSxJQUFBLENBQUEsQ0FBQSxDQUFBLENBQUE7Z0JBQ0EsTUFBQSxDQUFBO1lBQ0EsQ0FBQTtZQUNBLElBQUEsQ0FBQSxJQUFBLENBQUEsVUFBQSxDQUFBLEVBQUEsT0FBQTtnQkFDQSxJQUFBLEdBQUEsR0FBQSxDQUFBLENBQUEsT0FBQSxDQUFBLENBQUE7Z0JBQ0EsRUFBQSxDQUFBLENBQUEsR0FBQSxDQUFBLEVBQUEsQ0FBQSxPQUFBLENBQUEsSUFBQSxHQUFBLENBQUEsRUFBQSxDQUFBLFVBQUEsQ0FBQSxDQUFBLENBQUEsQ0FBQTtvQkFDQSxHQUFBLENBQUEsR0FBQSxDQUFBLEtBQUEsQ0FBQSxDQUFBO29CQUNBLE1BQUEsQ0FBQTtnQkFDQSxDQUFBO2dCQUNBLEVBQUEsQ0FBQSxDQUFBLEdBQUEsQ0FBQSxFQUFBLENBQUEsS0FBQSxDQUFBLENBQUEsQ0FBQSxDQUFBO29CQUNBLEdBQUEsQ0FBQSxJQUFBLENBQUEsS0FBQSxFQUFBLEtBQUEsQ0FBQSxDQUFBO29CQUNBLE1BQUEsQ0FBQTtnQkFDQSxDQUFBO2dCQUNBLEVBQUEsQ0FBQSxDQUFBLFFBQUEsQ0FBQSxPQUFBLENBQUEsUUFBQSxDQUFBLENBQUEsQ0FBQTtvQkFDQSxHQUFBLENBQUEsTUFBQSxDQUFBLEtBQUEsQ0FBQSxDQUFBO2dCQUNBLENBQUE7Z0JBQUEsSUFBQSxDQUFBLENBQUE7b0JBQ0EsR0FBQSxDQUFBLE9BQUEsQ0FBQSxLQUFBLENBQUEsQ0FBQTtnQkFDQSxDQUFBO1lBQ0EsQ0FBQSxDQUFBLENBQUE7UUFDQSxDQUFBLENBQUEsQ0FBQTtJQUNBLENBQUE7SUFFQSx3QkFBQSxHQUFBO1FBQ0EsRUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsT0FBQSxJQUFBLElBQUEsQ0FBQSxPQUFBLENBQUEsTUFBQSxHQUFBLENBQUEsQ0FBQSxDQUFBLENBQUE7WUFDQSxNQUFBLENBQUEsRUFBQSxDQUFBO1FBQ0EsQ0FBQTtRQUNBLElBQUEsSUFBQSxHQUFBLEVBQUEsQ0FBQTtRQUNBLElBQUEsR0FBQSxHQUFBLElBQUEsQ0FBQSxPQUFBLENBQUEsSUFBQSxDQUFBLFdBQUEsQ0FBQSxDQUFBO1FBQ0EsRUFBQSxDQUFBLENBQUEsQ0FBQSxHQUFBLENBQUEsQ0FBQSxDQUFBO1lBQ0EsTUFBQSxDQUFBLElBQUEsQ0FBQTtRQUNBLENBQUE7UUFDQSxJQUFBLElBQUEsR0FBQSxHQUFBLENBQUEsS0FBQSxDQUFBLEdBQUEsQ0FBQSxDQUFBO1FBQ0EsSUFBQSxDQUFBLE9BQUEsQ0FBQSxVQUFBLElBQUE7WUFDQSxJQUFBLFFBQUEsR0FBQSxJQUFBLENBQUEsS0FBQSxDQUFBLEdBQUEsQ0FBQSxDQUFBO1lBQ0EsSUFBQSxHQUFBLEdBQUEsUUFBQSxDQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsRUFBQSxDQUFBO1lBQ0EsRUFBQSxDQUFBLENBQUEsR0FBQSxDQUFBLENBQUEsQ0FBQTtnQkFDQSxJQUFBLENBQUEsR0FBQSxDQUFBLEdBQUEsUUFBQSxDQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsRUFBQSxDQUFBO1lBQ0EsQ0FBQTtRQUNBLENBQUEsQ0FBQSxDQUFBO1FBQ0EsTUFBQSxDQUFBLElBQUEsQ0FBQTtJQUNBLENBQUE7SUFFQSx3QkFBQSxHQUFBLFVBQUEsSUFBQTtRQUNBLElBQUEsSUFBQSxHQUFBLE9BQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxRQUFBLElBQUEsVUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsT0FBQSxDQUFBLFFBQUEsQ0FBQSxJQUFBLENBQUEsSUFBQSxFQUFBLElBQUEsQ0FBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsT0FBQSxDQUFBLFFBQUEsQ0FBQTtRQUNBLEdBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBQSxJQUFBLElBQUEsQ0FBQSxDQUFBLENBQUE7WUFDQSxFQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsY0FBQSxDQUFBLENBQUEsQ0FBQSxDQUFBLENBQUEsQ0FBQTtnQkFDQSxJQUFBLEdBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxJQUFBLE1BQUEsQ0FBQSxHQUFBLEdBQUEsQ0FBQSxHQUFBLEdBQUEsRUFBQSxHQUFBLENBQUEsRUFBQSxJQUFBLENBQUEsQ0FBQSxDQUFBLENBQUEsQ0FBQTtZQUNBLENBQUE7UUFDQSxDQUFBO1FBQ0EsTUFBQSxDQUFBLElBQUEsQ0FBQTtJQUNBLENBQUE7SUFDQSxhQUFBO0FBQUEsQ0EvTkEsQUErTkEsQ0EvTkEsR0FBQSxHQStOQTtBQXdCQTtJQUFBO1FBRUEsU0FBQSxHQUFBLE1BQUEsQ0FBQTtRQUNBLGFBQUEsR0FBQSxJQUFBLENBQUE7UUFDQSxhQUFBLEdBQUEsT0FBQSxDQUFBO1FBQ0EsMkJBQUE7UUFDQSxjQUFBLEdBQUEsU0FBQSxDQUFBO1FBQ0EsbUJBQUEsR0FBQTtZQUNBLENBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQSxNQUFBLEVBQUEsQ0FBQSxNQUFBLEVBQUEsQ0FBQTtRQUNBLENBQUEsQ0FBQTtRQUNBLGFBQUEsR0FBQSxLQUFBLENBQUE7UUFDQSxrQkFBQSxHQUFBLEtBQUEsQ0FBQTtRQUNBLFNBQUEsR0FBQSxFQUFBLENBQUE7UUFDQSxjQUFBLEdBQUEsY0FBQSxDQUFBO1FBQ0EsV0FBQSxHQUFBLEVBQUEsQ0FBQTtRQUNBLFlBQUEsR0FBQSxVQUFBLElBQUE7WUFDQSxpQkFBQTtZQUNBLEVBQUEsQ0FBQSxDQUFBLE9BQUEsSUFBQSxJQUFBLFFBQUEsQ0FBQSxDQUFBLENBQUE7Z0JBQ0EsSUFBQSxHQUFBLElBQUEsQ0FBQSxLQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7WUFDQSxDQUFBO1lBQ0EsRUFBQSxDQUFBLENBQUEsSUFBQSxDQUFBLElBQUEsSUFBQSxDQUFBLENBQUEsQ0FBQSxDQUFBO2dCQUNBLE1BQUEsQ0FBQSxJQUFBLENBQUEsSUFBQSxDQUFBO1lBQ0EsQ0FBQTtZQUNBLE1BQUEsQ0FBQSxLQUFBLENBQUE7UUFDQSxDQUFBLENBQUE7UUFDQSxZQUFBLEdBQUEsSUFBQSxDQUFBO1FBQ0EsZUFBQSxHQUFBLFVBQUEsR0FBQTtZQUNBLE1BQUEsQ0FBQSxDQUFBLENBQUEsR0FBQSxDQUFBLENBQUE7UUFDQSxDQUFBLENBQUE7SUFDQSxDQUFBO0lBQUEsMEJBQUE7QUFBQSxDQTdCQSxBQTZCQSxJQUFBO0FBR0EsQ0FBQTtBQUFBLENBQUEsVUFBQSxDQUFBO0lBQ0EsQ0FBQSxDQUFBLEVBQUEsQ0FBQSxNQUFBLEdBQUEsVUFBQSxNQUFBO1FBQ0EsTUFBQSxDQUFBLElBQUEsTUFBQSxDQUFBLElBQUEsRUFBQSxNQUFBLENBQUEsQ0FBQTtJQUNBLENBQUEsQ0FBQTtBQUNBLENBQUEsQ0FBQSxDQUFBLE1BQUEsQ0FBQSxDQUFBIiwiZmlsZSI6ImpxdWVyeS51cGxvYWQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJhYnN0cmFjdCBjbGFzcyBFdmUge1xyXG4gICAgcHVibGljIG9wdGlvbnM6IGFueTtcclxuXHJcbiAgICBwdWJsaWMgb24oZXZlbnQ6IHN0cmluZywgY2FsbGJhY2s6IEZ1bmN0aW9uKTogdGhpcyB7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zWydvbicgKyBldmVudF0gPSBjYWxsYmFjaztcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgaGFzRXZlbnQoZXZlbnQ6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ29uJyArIGV2ZW50KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdHJpZ2dlcihldmVudDogc3RyaW5nLCAuLi4gYXJnczogYW55W10pIHtcclxuICAgICAgICBsZXQgcmVhbEV2ZW50ID0gJ29uJyArIGV2ZW50O1xyXG4gICAgICAgIGlmICghdGhpcy5oYXNFdmVudChldmVudCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zW3JlYWxFdmVudF0uY2FsbCh0aGlzLCAuLi5hcmdzKTtcclxuICAgIH1cclxufSIsIi8qIVxyXG4gKiBqcXVlcnkudXBsb2FkIC0gaHR0cHM6Ly9naXRodWIuY29tL3p4NjQ4MzgzMDc5L1pvRHJlYW0uVUlcclxuICogVmVyc2lvbiAtIDEuMFxyXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgLSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUXHJcbiAqXHJcbiAqIENvcHlyaWdodCAoYykgMjAxNyBab0RyZWFtXHJcbiAqL1xyXG4vKipcclxuICogRVhBTVBMRTpcclxuICogJCgnI3VwbG9hZCcpLnVwbG9hZCh7XHJcbiAqICAgICAgdXJsOiAndXBsb2FkLnBocCcsXHJcbiAqICAgICAgbmFtZTogJ2ZpbGUnLFxyXG4gKiAgICAgIHRlbXBsYXRlOiAne3VybH0nLFxyXG4gKiAgICAgIGdyaWQ6ICcuaW1nJ1xyXG4gKiB9KTtcclxuICovXHJcbmNsYXNzIFVwbG9hZCBleHRlbmRzIEV2ZSB7XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwdWJsaWMgZWxlbWVudD86IEpRdWVyeSxcclxuICAgICAgICBvcHRpb24/OiBVcGxvYWRPcHRpb25cclxuICAgICkge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zID0gJC5leHRlbmQoe30sIG5ldyBVcGxvYWREZWZhdWx0T3B0aW9uKCksIG9wdGlvbik7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zLmRhdGEgPSAkLmV4dGVuZCh7fSwgdGhpcy5vcHRpb25zLmRhdGEsIHRoaXMuZ2V0RGF0YSgpKTtcclxuICAgICAgICB0aGlzLmdldEVsZW1lbnQgPSB0aGlzLm9wdGlvbnMuZ2V0RWxlbWVudC5iaW5kKHRoaXMpO1xyXG4gICAgICAgIGlmICh0aGlzLmVsZW1lbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5hZGRFdmVudCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgb3B0aW9uczogVXBsb2FkT3B0aW9uO1xyXG5cclxuICAgIHB1YmxpYyBzdWNjZXNzOiAoZGF0YTogYW55LCBjdXJyZW50RWxlbWVudDogSlF1ZXJ5KSA9PiBib29sZWFuO1xyXG5cclxuICAgIHB1YmxpYyBnZXRFbGVtZW50OiAodGFnOiBzdHJpbmcsIGN1cnJlbnRFbGVtZW50OiBKUXVlcnkpID0+IEpRdWVyeTtcclxuXHJcbiAgICBwcml2YXRlIGN1cnJlbnRFbGVtZW50OiBKUXVlcnk7XHJcblxyXG4gICAgcHVibGljIGFkZEV2ZW50KCkge1xyXG4gICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5lbGVtZW50LmNsaWNrKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBpbnN0YW5jZS5zdGFydCgkKHRoaXMpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmdyaWQpIHtcclxuICAgICAgICAgICAgJCh0aGlzLm9wdGlvbnMuZ3JpZCkub24oJ2NsaWNrJywgdGhpcy5vcHRpb25zLnJlbW92ZVRhZywgdGhpcy5vcHRpb25zLnJlbW92ZUNhbGxiYWNrKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXJ0KGN1cnJlbnRFbGVtZW50PzogSlF1ZXJ5KSB7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50RWxlbWVudCA9IGN1cnJlbnRFbGVtZW50O1xyXG4gICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXM7XHJcbiAgICAgICAgbGV0IGVsZW1lbnQgPSAkKCcuJyArIHRoaXMub3B0aW9ucy5maWxlQ2xhc3MpO1xyXG4gICAgICAgIGlmIChlbGVtZW50Lmxlbmd0aCA8IDEpIHtcclxuICAgICAgICAgICAgbGV0IGZpbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xyXG4gICAgICAgICAgICBmaWxlLnR5cGUgPSAnZmlsZSc7XHJcbiAgICAgICAgICAgIGZpbGUuY2xhc3NOYW1lID0gdGhpcy5vcHRpb25zLmZpbGVDbGFzcztcclxuICAgICAgICAgICAgZmlsZS5tdWx0aXBsZSA9IHRoaXMub3B0aW9ucy5tdWx0aXBsZTtcclxuICAgICAgICAgICAgZmlsZS5hY2NlcHQgPSB0aGlzLm9wdGlvbnMuZmlsdGVyO1xyXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGZpbGUpO1xyXG4gICAgICAgICAgICBlbGVtZW50ID0gJChmaWxlKS5iaW5kKCdjaGFuZ2UnLCBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgIGluc3RhbmNlLnVwbG9hZEZpbGVzKHRoaXMuZmlsZXMpO1xyXG4gICAgICAgICAgICB9KS5oaWRlKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZWxlbWVudC52YWwoJycpO1xyXG4gICAgICAgICAgICBlbGVtZW50LmF0dHIoJ211bHRpcGxlJywgdGhpcy5vcHRpb25zLm11bHRpcGxlID8gJ3RydWUnIDogJ2ZhbHNlJyk7XHJcbiAgICAgICAgICAgIGVsZW1lbnQuYXR0cignYWNjZXB0JywgdGhpcy5vcHRpb25zLmZpbHRlcik7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZHluYW1pYykge1xyXG4gICAgICAgICAgICAgICAgZWxlbWVudC51bmJpbmQoJ2NoYW5nZScpLmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLnVwbG9hZEZpbGVzKHRoaXMuZmlsZXMpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxlbWVudC5jbGljaygpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyB1cGxvYWRGaWxlcyhmaWxlcykge1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYWxsb3dNdWx0aXBsZSkge1xyXG4gICAgICAgICAgICB0aGlzLnVwbG9hZE1hbnkoZmlsZXMpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXM7XHJcbiAgICAgICAgJC5lYWNoKGZpbGVzLCBmdW5jdGlvbihpLCBmaWxlKSB7XHJcbiAgICAgICAgICAgIGluc3RhbmNlLnVwbG9hZE9uZShmaWxlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdXBsb2FkTWFueShmaWxlcykge1xyXG4gICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXM7XHJcbiAgICAgICAgbGV0IGRhdGEgPSBuZXcgRm9ybURhdGEoKTtcclxuICAgICAgICAkLmVhY2goZmlsZXMsIGZ1bmN0aW9uKGksIGZpbGUpIHtcclxuICAgICAgICAgICAgZGF0YS5hcHBlbmQoaW5zdGFuY2Uub3B0aW9ucy5uYW1lLCBmaWxlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAodGhpcy50cmlnZ2VyKCdiZWZvcmUnLCBkYXRhLCB0aGlzLmN1cnJlbnRFbGVtZW50KSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ2JlZm9yZSB1cGxvYWQgaXMgZmFsc2UnKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgb3B0cyA9IHtcclxuICAgICAgICAgICAgdXJsOiB0aGlzLm9wdGlvbnMudXJsLFxyXG4gICAgICAgICAgICB0eXBlOidQT1NUJyxcclxuICAgICAgICAgICAgZGF0YTogZGF0YSxcclxuICAgICAgICAgICAgY2FjaGU6IGZhbHNlLFxyXG4gICAgICAgICAgICBjb250ZW50VHlwZTogZmFsc2UsICAgIC8v5LiN5Y+v57y6XHJcbiAgICAgICAgICAgIHByb2Nlc3NEYXRhOiBmYWxzZSwgICAgLy/kuI3lj6/nvLpcclxuICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgZGF0YSA9IGluc3RhbmNlLnRyaWdnZXIoJ2FmdGVyJywgZGF0YSwgaW5zdGFuY2UuY3VycmVudEVsZW1lbnQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEgPT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnYWZ0ZXIgdXBsb2FkIGlzIGZhbHNlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICAgICAgICAgICAgICAgICQuZWFjaChkYXRhLCBmdW5jdGlvbihpLCBpdGVtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmRlYWwoJC5leHRlbmQoe30sIGluc3RhbmNlLm9wdGlvbnMuZGF0YSwgaXRlbSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGluc3RhbmNlLmRlYWwoJC5leHRlbmQoe30sIGluc3RhbmNlLm9wdGlvbnMuZGF0YSwgZGF0YSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAodGhpcy5oYXNFdmVudCgncHJvZ3Jlc3MnKSkge1xyXG4gICAgICAgICAgICBvcHRzWyd4aHInXSA9IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICBsZXQgeGhyID0gJC5hamF4U2V0dGluZ3MueGhyKCk7XHJcbiAgICAgICAgICAgICAgICBpZihvbnByb2dyZXNzICYmIHhoci51cGxvYWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB4aHIudXBsb2FkLmFkZEV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJyAsIHRoaXMub3B0aW9ucy5vbnByb2dyZXNzLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHhocjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgJC5hamF4KG9wdHMpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyB1cGxvYWRPbmUoZmlsZTogRmlsZSkge1xyXG4gICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXM7XHJcbiAgICAgICAgbGV0IGRhdGEgPSBuZXcgRm9ybURhdGEoKTtcclxuICAgICAgICBkYXRhLmFwcGVuZCh0aGlzLm9wdGlvbnMubmFtZSwgZmlsZSk7XHJcbiAgICAgICAgaWYgKHRoaXMudHJpZ2dlcignYmVmb3JlJywgZGF0YSwgdGhpcy5jdXJyZW50RWxlbWVudCkgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdiZWZvcmUgdXBsb2FkIGlzIGZhbHNlJyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IG9wdHMgPSB7XHJcbiAgICAgICAgICAgIHVybDogdGhpcy5vcHRpb25zLnVybCxcclxuICAgICAgICAgICAgdHlwZTonUE9TVCcsXHJcbiAgICAgICAgICAgIGRhdGE6IGRhdGEsXHJcbiAgICAgICAgICAgIGNhY2hlOiBmYWxzZSxcclxuICAgICAgICAgICAgY29udGVudFR5cGU6IGZhbHNlLCAgICAvL+S4jeWPr+e8ulxyXG4gICAgICAgICAgICBwcm9jZXNzRGF0YTogZmFsc2UsICAgIC8v5LiN5Y+v57y6XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGRhdGEgPSBpbnN0YW5jZS50cmlnZ2VyKCdhZnRlcicsIGRhdGEsIGluc3RhbmNlLmN1cnJlbnRFbGVtZW50KTtcclxuICAgICAgICAgICAgICAgIGlmIChkYXRhID09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2FmdGVyIHVwbG9hZCBpcyBmYWxzZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGluc3RhbmNlLmRlYWwoJC5leHRlbmQoe30sIGluc3RhbmNlLm9wdGlvbnMuZGF0YSwgZGF0YSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAodGhpcy5oYXNFdmVudCgncHJvZ3Jlc3MnKSkge1xyXG4gICAgICAgICAgICBvcHRzWyd4aHInXSA9IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICBsZXQgeGhyID0gJC5hamF4U2V0dGluZ3MueGhyKCk7XHJcbiAgICAgICAgICAgICAgICBpZihvbnByb2dyZXNzICYmIHhoci51cGxvYWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB4aHIudXBsb2FkLmFkZEV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJyAsIHRoaXMub3B0aW9ucy5vbnByb2dyZXNzLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHhocjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgJC5hamF4KG9wdHMpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBkZWFsKGRhdGE6IGFueSkge1xyXG4gICAgICAgIGxldCB2YWx1ZSA9IHR5cGVvZiB0aGlzLm9wdGlvbnMudGVtcGxhdGUgPT0gJ2Z1bmN0aW9uJyA/IHRoaXMub3B0aW9ucy50ZW1wbGF0ZS5jYWxsKHRoaXMsIGRhdGEpIDogdGhpcy5yZXBsYWNlKGRhdGEpO1xyXG4gICAgICAgIGlmICh2YWx1ZSA9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygndGVtcGxhdGUgaXMgZmFsc2UnKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZmFsc2UgPT09IHRoaXMudHJpZ2dlcignc3VjY2VzcycsIGRhdGEsIHRoaXMuY3VycmVudEVsZW1lbnQpKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzdWNjZXNzIGlzIGZhbHNlJyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHVybEZvciA9IHRoaXMub3B0aW9ucy5ncmlkO1xyXG4gICAgICAgIGlmICh0aGlzLmN1cnJlbnRFbGVtZW50ICYmIHRoaXMuY3VycmVudEVsZW1lbnQubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICB1cmxGb3IgPSB0aGlzLmN1cnJlbnRFbGVtZW50LmF0dHIoJ2RhdGEtZ3JpZCcpIHx8IHRoaXMub3B0aW9ucy5ncmlkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXVybEZvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnZ3JpZCBlbGVtZW50IGlzIGZhbHNlJyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHRhZ3MgPSB1cmxGb3Iuc3BsaXQoJ3wnKTtcclxuICAgICAgICBsZXQgaW5zdGFuY2UgPSB0aGlzO1xyXG4gICAgICAgIHRhZ3MuZm9yRWFjaChmdW5jdGlvbih0YWcpIHtcclxuICAgICAgICAgICAgbGV0IGl0ZW0gPSBpbnN0YW5jZS5nZXRFbGVtZW50KHRhZywgaW5zdGFuY2UuY3VycmVudEVsZW1lbnQpO1xyXG4gICAgICAgICAgICBpZiAoaXRlbS5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGl0ZW0uZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZWxlID0gJChlbGVtZW50KTtcclxuICAgICAgICAgICAgICAgIGlmIChlbGUuaXMoJ2lucHV0JykgfHwgZWxlLmlzKCd0ZXh0YXJlYScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxlLnZhbCh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGVsZS5pcygnaW1nJykpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbGUuYXR0cignc3JjJywgdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5vcHRpb25zLmlzQXBwZW5kKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxlLmFwcGVuZCh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGVsZS5wcmVwZW5kKHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldERhdGEoKTogYW55IHtcclxuICAgICAgICBpZiAoIXRoaXMuZWxlbWVudCB8fCB0aGlzLmVsZW1lbnQubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgICAgICByZXR1cm4ge307XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBkYXRhID0ge307XHJcbiAgICAgICAgbGV0IGFyZyA9IHRoaXMuZWxlbWVudC5hdHRyKCdkYXRhLWRhdGEnKTtcclxuICAgICAgICBpZiAoIWFyZykge1xyXG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IGFyZ3MgPSBhcmcuc3BsaXQoJywnKTtcclxuICAgICAgICBhcmdzLmZvckVhY2goZnVuY3Rpb24oaXRlbSkge1xyXG4gICAgICAgICAgICBsZXQga2V5VmFsdWUgPSBpdGVtLnNwbGl0KCc6Jyk7XHJcbiAgICAgICAgICAgIGxldCBrZXkgPSBrZXlWYWx1ZVswXS50cmltKCk7XHJcbiAgICAgICAgICAgIGlmIChrZXkpIHtcclxuICAgICAgICAgICAgICAgIGRhdGFba2V5XSA9IGtleVZhbHVlWzFdLnRyaW0oKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBkYXRhO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyByZXBsYWNlKGRhdGE6IE9iamVjdCk6IHN0cmluZyB7XHJcbiAgICAgICAgbGV0IGh0bWw6IHN0cmluZyA9IHR5cGVvZiB0aGlzLm9wdGlvbnMudGVtcGxhdGUgPT0gJ2Z1bmN0aW9uJyA/IHRoaXMub3B0aW9ucy50ZW1wbGF0ZS5jYWxsKHRoaXMsIGRhdGEpIDogdGhpcy5vcHRpb25zLnRlbXBsYXRlO1xyXG4gICAgICAgIGZvciAobGV0IGkgaW4gZGF0YSkge1xyXG4gICAgICAgICAgICBpZiAoZGF0YS5oYXNPd25Qcm9wZXJ0eShpKSkge1xyXG4gICAgICAgICAgICAgICAgaHRtbCA9IGh0bWwucmVwbGFjZShuZXcgUmVnRXhwKCd7JyArIGkgKyAnfScsICdnJyksIGRhdGFbaV0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBodG1sO1xyXG4gICAgfVxyXG59XHJcblxyXG5pbnRlcmZhY2UgVXBsb2FkT3B0aW9uIHtcclxuICAgIFtzZXR0aW5nOiBzdHJpbmddOiBhbnksXHJcbiAgICB1cmw/OiBzdHJpbmcsICAgICAgICAgLy8g5LiK5Lyg572R5Z2AXHJcbiAgICBuYW1lPzogc3RyaW5nLCAgICAgICAgLy8g5LiK5Lyg5ZCNXHJcbiAgICBpc0FwcGVuZD86IGJvb2xlYW4sICAgIC8v5Zyo5ZCO6Z2i5Yqg6L+Y5piv5YmN6Z2i5YqgIO+8jOWvueWkmuS4quacieaViFxyXG4gICAgdGVtcGxhdGU/OiBzdHJpbmcgfCBGdW5jdGlvbiwgICAgLy8g5qih5p2/XHJcbiAgICBncmlkPzogc3RyaW5nLCAgICAgICAgLy8g6KOF6L295a655ZmoXHJcbiAgICBkYXRhPzogYW55LCAgICAgICAgICAgLy/pu5jorqTlgLxcclxuICAgIHJlbW92ZVRhZz86IHN0cmluZywgICAvLyDliKDpmaTmoIflv5dcclxuICAgIHJlbW92ZUNhbGxiYWNrPzogKGV2ZW50T2JqZWN0OiBKUXVlcnlFdmVudE9iamVjdCwgLi4uZXZlbnREYXRhOiBhbnlbXSkgPT4gYW55LCAgLy/liKDpmaTop6blj5Hkuovku7ZcclxuICAgIG11bHRpcGxlPzogYm9vbGVhbiwgICAvLyDmmK/lkKblhYHorrjkuIrkvKDlpJrkuKpcclxuICAgIGZpbGVDbGFzcz86IHN0cmluZywgICAvLyDkuIrkvKDmlofku7ZDbGFzcyDlkI1cclxuICAgIGZpbHRlcj86IHN0cmluZywgICAgICAgLy8g5paH5Lu26L+H5rukXHJcbiAgICBvbmJlZm9yZT86IChkYXRhOiBGb3JtRGF0YSwgY3VycmVudEVsZW1lbnQ6IEpRdWVyeSkgPT4gYW55LCAgLy/pqozor4HopoHkuIrkvKDnmoTmlofku7ZcclxuICAgIG9uYWZ0ZXI/OiAoZGF0YTogYW55LCBjdXJyZW50RWxlbWVudDogSlF1ZXJ5KSA9PiBhbnksICAgLy/pqozor4HkuIrkvKDov5Tlm57mlbDmja5cclxuICAgIG9uc3VjY2Vzcz86IChkYXRhOiBhbnksIGN1cnJlbnRFbGVtZW50OiBKUXVlcnkpID0+IGJvb2xlYW4gLCAgICAgLy/miJDlip/mt7vliqDlm57mjolcclxuICAgIGR5bmFtaWM/OiBib29sZWFuLCAvL+aYr+WQpuWKqOaAgee7keWumuS4iuS8oOaXtumXtFxyXG4gICAgZ2V0RWxlbWVudD86ICh0YWc6IHN0cmluZywgY3VycmVudEVsZW1lbnQ6IEpRdWVyeSkgPT4gSlF1ZXJ5LCAgIC8v6I635Y+W5a655Zmo55qE5pa55rOVXHJcbiAgICBvbnByb2dyZXNzPzogKGRhdGE6IGFueSkgPT4gdm9pZCwgLy8g5LiK5Lyg6L+b5bqmXHJcbiAgICBhbGxvd011bHRpcGxlPzogYm9vbGVhbiwgICAgIC8vIOaYr+WQpuWFgeiuuOS4iuS8oOS4gOasoeWkmuS4qlxyXG59XHJcblxyXG5jbGFzcyBVcGxvYWREZWZhdWx0T3B0aW9uIGltcGxlbWVudHMgVXBsb2FkT3B0aW9uIHtcclxuICAgIFtzZXR0aW5nOiBzdHJpbmddOiBhbnk7XHJcbiAgICBuYW1lOiBzdHJpbmcgPSAnZmlsZSc7XHJcbiAgICBpc0FwcGVuZDogYm9vbGVhbiA9IHRydWU7XHJcbiAgICB0ZW1wbGF0ZTogc3RyaW5nID0gJ3t1cmx9JztcclxuICAgIC8vZ3JpZDogc3RyaW5nID0gJy56ZEdyaWQnO1xyXG4gICAgcmVtb3ZlVGFnOiBzdHJpbmcgPSAnLmRlbGV0ZSc7XHJcbiAgICByZW1vdmVDYWxsYmFjazogKGV2ZW50T2JqZWN0OiBKUXVlcnlFdmVudE9iamVjdCwgLi4uZXZlbnREYXRhOiBhbnlbXSkgPT4gYW55ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5yZW1vdmUoKTtcclxuICAgIH07XHJcbiAgICBtdWx0aXBsZTogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgYWxsb3dNdWx0aXBsZTogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgZGF0YTogYW55ID0ge307XHJcbiAgICBmaWxlQ2xhc3M6IHN0cmluZyA9ICd6ZFVwbG9hZEZpbGUnO1xyXG4gICAgZmlsdGVyOiBzdHJpbmcgPSAnJztcclxuICAgIG9uYWZ0ZXI6IChkYXRhOiBhbnkpID0+IGFueSA9IGZ1bmN0aW9uKGRhdGE6IGFueSkge1xyXG4gICAgICAgIC8vIOmYsuatomFqYXjoh6rliqjovazljJZqc29uXHJcbiAgICAgICAgaWYgKHR5cGVvZiBkYXRhICE9ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIGRhdGEgPSBKU09OLnBhcnNlKGRhdGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZGF0YS5jb2RlID09IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIGRhdGEuZGF0YTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfTtcclxuICAgIGR5bmFtaWM6IGJvb2xlYW4gPSB0cnVlO1xyXG4gICAgZ2V0RWxlbWVudDogKHRhZzogc3RyaW5nLCBjdXJyZW50RWxlbWVudDogSlF1ZXJ5KSA9PiBKUXVlcnkgPSBmdW5jdGlvbih0YWc6IHN0cmluZyk6IEpRdWVyeSB7XHJcbiAgICAgICAgcmV0dXJuICQodGFnKTtcclxuICAgIH1cclxufVxyXG5cclxuXHJcbjsoZnVuY3Rpb24oJDogYW55KSB7XHJcbiAgJC5mbi51cGxvYWQgPSBmdW5jdGlvbihvcHRpb24gPzogVXBsb2FkT3B0aW9uKSB7XHJcbiAgICByZXR1cm4gbmV3IFVwbG9hZCh0aGlzLCBvcHRpb24pOyBcclxuICB9O1xyXG59KShqUXVlcnkpOyJdfQ==
